<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modder Profile</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .btn {
      background-color: #24292e;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      display: inline-block;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #444;
    }
    .hidden { display: none; }
    .profile-picture {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Modder Profile</h1>

    <!-- Section asking for GitHub username -->
    <div id="userInputSection">
      <label for="githubUsername">Enter your GitHub Username:</label>
      <input type="text" id="githubUsername" placeholder="e.g., softmonster">
      
      <br><br>
      
      <button class="btn" id="generateProfileBtn" onclick="generateModderProfile()">Generate Profile</button>
    </div>

    <!-- Section to show the generated modder profile -->
    <div id="modderProfileSection" class="hidden">
      <h2>Welcome, <span id="username">user</span>!</h2>
      <img id="profilePic" class="profile-picture" src="" alt="Profile Picture">
      <p id="bio"></p>

      <h3>KeeperRL Community Activity</h3>
      <ul id="activityList">
        <li><a href="" target="_blank" id="keeperrlWikiCommits">keeperrl_wiki commits</a> (<span id="keeperrlWikiCommitsCount">Check later</span>)</li>
        <li><a href="" target="_blank" id="keeperrlCommits">keeperrl commits</a> (<span id="keeperrlCommitsCount">Check later</span>)</li>
        <li><a href="" target="_blank" id="communityResourcesCommits">Community Resources commits</a> (<span id="communityResourcesCommitsCount">Check later</span>)</li>
        <li><a href="" target="_blank" id="keeperrlWikiIssues">keeperrl_wiki issues</a> (<span id="keeperrlWikiIssuesCount">Check later</span>)</li>
        <li><a href="" target="_blank" id="keeperrlIssues">keeperrl issues</a> (<span id="keeperrlIssuesCount">Check later</span>)</li>
        <li><a href="" target="_blank" id="communityResourcesIssues">Community Resources issues</a> (<span id="communityResourcesIssuesCount">Check later</span>)</li>
        <li><a href="" target="_blank" id="keeperrlWikiPRs">keeperrl_wiki PRs</a> (<span id="keeperrlWikiPRsCount">Check later</span>)</li>
        <li><a href="" target="_blank" id="keeperrlPRs">keeperrl PRs</a> (<span id="keeperrlPRsCount">Check later</span>)</li>
        <li><a href="" target="_blank" id="communityResourcesPRs">Community Resources PRs</a> (<span id="communityResourcesPRsCount">Check later</span>)</li>
      </ul>

      <h3>Other Public Projects</h3>
      <div id="repos">
        <p>Check later</p>
      </div>

      <!-- Button to download the profile -->
      <button class="btn" onclick="downloadProfile()">Download Profile as HTML</button>
    </div>
  </div>

  <script>
    // Function to generate the modder profile
    async function generateModderProfile() {
      const username = document.getElementById('githubUsername').value;

      if (!username) {
        alert("Please enter a valid GitHub username.");
        return;
      }

      document.getElementById('userInputSection').classList.add('hidden');
      document.getElementById('modderProfileSection').classList.remove('hidden');
      document.getElementById('username').textContent = username;

      // Default values in case of error
      const defaultMessage = 'Check later';
      const profilePicURL = ''; // Empty profile pic for errors
      const bioMessage = defaultMessage;

      // Fetch GitHub profile data for the given username
      try {
        const profileResponse = await fetch(`https://api.github.com/users/${username}`);
        const profileData = await profileResponse.json();

        if (profileData.message === "Not Found") {
          alert("GitHub user not found. Please check the username.");
          // Set default values in case of error
          document.getElementById('profilePic').src = profilePicURL;
          document.getElementById('bio').textContent = bioMessage;
          return;
        }

        // Populate profile info
        document.getElementById('profilePic').src = profileData.avatar_url || profilePicURL;
        document.getElementById('bio').textContent = profileData.bio || bioMessage;

        // Set commit links for community repositories
        document.getElementById("keeperrlWikiCommits").href = `https://github.com/miki151/keeperrl_wiki/commits?author=${username}`;
        document.getElementById("keeperrlCommits").href = `https://github.com/miki151/keeperrl/commits?author=${username}`;
        document.getElementById("communityResourcesCommits").href = `https://github.com/miki151/KeeperRLCommunityResources/commits?author=${username}`;

        document.getElementById("keeperrlWikiIssues").href = `https://github.com/miki151/keeperrl_wiki/issues?q=author:${username}`;
        document.getElementById("keeperrlIssues").href = `https://github.com/miki151/keeperrl/issues?q=author:${username}`;
        document.getElementById("communityResourcesIssues").href = `https://github.com/miki151/KeeperRLCommunityResources/issues?q=author:${username}`;

        document.getElementById("keeperrlWikiPRs").href = `https://github.com/miki151/keeperrl_wiki/pulls?q=author:${username}`;
        document.getElementById("keeperrlPRs").href = `https://github.com/miki151/keeperrl/pulls?q=author:${username}`;
        document.getElementById("communityResourcesPRs").href = `https://github.com/miki151/KeeperRLCommunityResources/pulls?q=author:${username}`;

        // Fetch the repositories for the given GitHub username
        const reposResponse = await fetch(`https://api.github.com/users/${username}/repos`);
        const repos = await reposResponse.json();

        if (repos.length === 0) {
          document.getElementById("repos").innerHTML = "<p>Check later</p>";
        } else {
          const repoList = repos.map(repo => `
            <li>
              <a href="${repo.html_url}" target="_blank">${repo.name}</a> - ${repo.description || 'No description'}
            </li>
          `).join('');
          
          document.getElementById("repos").innerHTML = `<ul>${repoList}</ul>`;
        }

        // Get commits, issues, and PRs for the KeeperRL community repositories
        const keeperRLRepos = ['keeperrl_wiki', 'keeperrl', 'KeeperRLCommunityResources'];
        for (const repo of keeperRLRepos) {
          // Get commits count
          const commitsResponse = await fetch(`https://api.github.com/repos/miki151/${repo}/commits?author=${username}`);
          const commits = await commitsResponse.json();
          document.getElementById(`${repo}CommitsCount`).textContent = commits.length > 0 ? commits.length : defaultMessage;

          // Get issues count
          const issuesResponse = await fetch(`https://api.github.com/repos/miki151/${repo}/issues?creator=${username}`);
          const issues = await issuesResponse.json();
          document.getElementById(`${repo}IssuesCount`).textContent = issues.length > 0 ? issues.length : defaultMessage;

          // Get pull requests count
          const prsResponse = await fetch(`https://api.github.com/repos/miki151/${repo}/pulls?creator=${username}`);
          const prs = await prsResponse.json();
          document.getElementById(`${repo}PRsCount`).textContent = prs.length > 0 ? prs.length : defaultMessage;
        }

      } catch (error) {
        console.error("Error fetching GitHub data:", error);
        // Set default values in case of error
        document.getElementById('profilePic').src = profilePicURL;
        document.getElementById('bio').textContent = bioMessage;
        document.getElementById("keeperrlWikiCommitsCount").textContent = defaultMessage;
        document.getElementById("keeperrlCommitsCount").textContent = defaultMessage;
        document.getElementById("communityResourcesCommitsCount").textContent = defaultMessage;
        document.getElementById("keeperrlWikiIssuesCount").textContent = defaultMessage;
        document.getElementById("keeperrlIssuesCount").textContent = defaultMessage;
        document.getElementById("communityResourcesIssuesCount").textContent = defaultMessage;
        document.getElementById("keeperrlWikiPRsCount").textContent = defaultMessage;
        document.getElementById("keeperrlPRsCount").textContent = defaultMessage;
        document.getElementById("communityResourcesPRsCount").textContent = defaultMessage;
        document.getElementById("repos").innerHTML = "<p>Check later</p>";
      }
    }

    // Function to download the profile as an HTML file
    function downloadProfile() {
      const username = document.getElementById('githubUsername').value || 'default_username'; // Using the entered username or default if not available

      const profileHtml = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
          <title>${username}'s Modder Profile</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              background-color: #f4f4f9;
              padding: 20px;
            }
            .container {
              max-width: 1000px;
              margin: 0 auto;
              background-color: #fff;
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .btn {
              background-color: #24292e;
              color: white;
              padding: 10px 20px;
              border-radius: 5px;
              text-decoration: none;
              display: inline-block;
              cursor: pointer;
            }
            .btn:hover {
              background-color: #444;
            }
            .profile-picture {
              width: 150px;
              height: 150px;
              border-radius: 50%;
              object-fit: cover;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>${username}'s Modder Profile</h1>
            <img src="${document.getElementById('profilePic').src}" alt="Profile Picture" class="profile-picture">
            <p>${document.getElementById('bio').textContent}</p>

            <h3>KeeperRL Community Activity</h3>
            <ul>
              <li><a href="${document.getElementById('keeperrlWikiCommits').href}" target="_blank">keeperrl_wiki commits</a> (${document.getElementById('keeperrlWikiCommitsCount').textContent})</li>
              <li><a href="${document.getElementById('keeperrlCommits').href}" target="_blank">keeperrl commits</a> (${document.getElementById('keeperrlCommitsCount').textContent})</li>
              <li><a href="${document.getElementById('communityResourcesCommits').href}" target="_blank">Community Resources commits</a> (${document.getElementById('communityResourcesCommitsCount').textContent})</li>
              <li><a href="${document.getElementById('keeperrlWikiIssues').href}" target="_blank">keeperrl_wiki issues</a> (${document.getElementById('keeperrlWikiIssuesCount').textContent})</li>
              <li><a href="${document.getElementById('keeperrlIssues').href}" target="_blank">keeperrl issues</a> (${document.getElementById('keeperrlIssuesCount').textContent})</li>
              <li><a href="${document.getElementById('communityResourcesIssues').href}" target="_blank">Community Resources issues</a> (${document.getElementById('communityResourcesIssuesCount').textContent})</li>
              <li><a href="${document.getElementById('keeperrlWikiPRs').href}" target="_blank">keeperrl_wiki PRs</a> (${document.getElementById('keeperrlWikiPRsCount').textContent})</li>
              <li><a href="${document.getElementById('keeperrlPRs').href}" target="_blank">keeperrl PRs</a> (${document.getElementById('keeperrlPRsCount').textContent})</li>
              <li><a href="${document.getElementById('communityResourcesPRs').href}" target="_blank">Community Resources PRs</a> (${document.getElementById('communityResourcesPRsCount').textContent})</li>
            </ul>

            <h3>Other Public Projects</h3>
            <div>${document.getElementById('repos').innerHTML}</div>
          </div>
        </body>
        </html>
      `;

      const blob = new Blob([profileHtml], { type: 'text/html' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${username}_modder_profile.html`; // Corrected filename based on the username
      link.click();
    }
  </script>
</body>
</html>
